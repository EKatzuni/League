<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Selection</title>
    <style>
        .winner {
            color: green;
        }

        .loser {
            color: red;
        }

        H4 {
            color: red;
        }

        table {
            border-collapse: collapse;
            width: 60%;
            margin-top: 20px;
        }

        th, td {
            border: 3px solid #9d9d9d;
            text-align: center;
            padding: 3px;
        }

        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
    </style>
</head>
<body>
  
    <h1>Select a Player / בחירת שחקן</h1>
    <select id="player-select">
        <option value="">Select a player</option>
    </select>

    <h1>Select a Cycle / בחירת מחזור</h1>
    <select id="round-select">
        <option value="">Select a cycle</option>
    </select>

    <h2>Games Played / משחקים ששוחקו</h2>
    <ul id="games-list"></ul>

    <script>
        // Function to sort player names alphabetically
        function sortPlayerNames(playerNames) {
            return playerNames.sort((a, b) => a.localeCompare(b));
        }

        // Google Sheets API Key
        const apiKey = 'AIzaSyAtPWvLQawbcd4vDiMyJk0bQG6AoTzYQZU';

        // Google Sheets Spreadsheet ID
        const spreadsheetId = '1QJCNQVtXOf2NF6R0uzbhi8own5hf0_E0K8QoailgMk4';

        // Fetch data from Google Sheets API
        function fetchDataFromGoogleSheets() {
            fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/Sheet1?key=${apiKey}`)
                .then(response => response.json())
                .then(data => {
                    const entries = data.values;
                    const selectPlayerElement = document.getElementById('player-select');
                    const selectRoundElement = document.getElementById('round-select');
                    const gamesList = document.getElementById('games-list');
                    const dataTable = document.getElementById('data-table');

                    // Populate player selection dropdown
                    const playerNames = [];
                    for (let i = 3; i < entries.length; i++) {
                        const playerName = entries[i][1].trim(); // Assuming player names are in column B
                        if (playerName && !playerNames.includes(playerName)) {
                            playerNames.push(playerName);
                        }
                    }

                    const sortedPlayerNames = sortPlayerNames(playerNames);

                    sortedPlayerNames.forEach(playerName => {
                        const option = document.createElement('option');
                        option.textContent = playerName;
                        option.value = playerName;
                        selectPlayerElement.appendChild(option);
                    });

                    // Populate round selection dropdown
                    const roundOptions = [];
                    for (let i = 3; i < entries.length; i++) {
                        const roundNumber = entries[i][7].trim(); // Assuming round numbers are in column H (column index 7)
                        if (roundNumber && !roundOptions.includes(roundNumber)) {
                            roundOptions.push(roundNumber);
                            const option = document.createElement('option');
                            option.textContent = `Cycle ${roundNumber}`;
                            option.value = roundNumber;
                            selectRoundElement.appendChild(option);
                        }
                    }

                    // Function to display games played by selected player and round
                    function displayGames() {
                        const selectedPlayer = selectPlayerElement.value;
                        const selectedRound = selectRoundElement.value;
                        gamesList.innerHTML = ''; // Clear previous games

                        let currentCycleTitle;

                        entries.forEach((entry, index) => {
                            if (index >= 3) {
                                const player = entry[9].trim(); // Assuming player names are in column J (column index 9)
                                const round = entry[7].trim(); // Assuming round numbers are in column H (column index 7)
                                if (player === selectedPlayer && (!selectedRound || round === selectedRound)) {
                                    const playerScore = parseFloat(entry[11].trim()); // Assuming player's score is in column L (column index 11)
                                    const opponentScore = parseFloat(entry[12].trim()); // Assuming opponent's score is in column M (column index 12)
                                    const isPlayerWinner = playerScore > opponentScore;
                                    const isOpponentWinner = playerScore < opponentScore;

                                    if (round !== currentCycleTitle) { // Check if a new cycle has started
                                        const cycleTitle = document.createElement('h3');
                                        cycleTitle.textContent = `Cycle ${round}`;
                                        gamesList.appendChild(cycleTitle);
                                        currentCycleTitle = round;
                                    }

                                    const gameItem = document.createElement('li');
                                    const gameSpan = document.createElement('span');
                                    const gameText = [player, entry[10].trim(), entry[11].trim(), entry[12].trim()].join(' - '); // Combine player, opponent, and scores
                                    gameSpan.textContent = gameText;
                                    // Apply color based on game result
                                    if (isPlayerWinner) {
                                        gameSpan.classList.add('winner');
                                    } else if (isOpponentWinner) {
                                        gameSpan.classList.add('loser');
                                    }
                                    gameItem.appendChild(gameSpan);
                                    gamesList.appendChild(gameItem);
                                }
                            }
                        });
                    }

                    // Event listeners for player and round selection
                    selectPlayerElement.addEventListener('change', displayGames);
                    selectRoundElement.addEventListener('change', displayGames);

                    // Display data table from row 4
                    for (let i = 3; i < 36; i++) {
                        const cells = entries[i];
                        if (cells.length >= 6) { // Ensure at least 6 columns are available
                            const row = document.createElement('tr');
                            for (let j = 5; j >= 0; j--) { // Displaying only columns 1 to 6
                                const cellElement = document.createElement('td');
                                const cellContent = cells[j].trim();
                                cellElement.textContent = cellContent;
                                row.appendChild(cellElement);
                                // Apply style for cells with numbers less than -100
                                if (j === 5 && !isNaN(cellContent) && parseInt(cellContent) === -100) {
                                    cellElement.style.backgroundColor = 'white'; // Change background color to white
                                    cellElement.style.color = 'white'; // Change text color to white
                                }
                            }
                            dataTable.appendChild(row);
                        }
                    }

                    // Set table headers
                    const tableHeaders = ['יחס', 'הפסדים', 'נצחונות', 'משחקים', 'שחקן', 'מיקום'];
                    const headerRow = document.createElement('tr');
                    tableHeaders.forEach(headerText => {
                        const headerCell = document.createElement('th');
                        headerCell.textContent = headerText;
                        headerRow.appendChild(headerCell);
                    });
                    dataTable.insertBefore(headerRow, dataTable.firstChild);                
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        // Call function to fetch data from Google Sheets API
        fetchDataFromGoogleSheets();
    </script>

    <h2>Summarizing table / טבלה מסכמת</h2>
    <table id="data-table">
        <tbody id="data-body"></tbody>
    </table>
</body>
</html>
