<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Selection</title>
    <style>
        .winner {
            color: green;
        }

        .loser {
            color: red;
        }

        table {
            border-collapse: collapse;
            width: 60%;
            margin-top: 20px;
        }

        th, td {
            border: 3px solid #9d9d9d;
            text-align: center;
            padding: 3px;
        }

        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        #non-playing-opponents-list li {
            text-align: right; /* Align text to the right */
            list-style-type: none; /* Remove bullet points */
            padding-right: 0; /* Remove default right padding */
            margin-right: 0; /* Remove default right margin */
            font-size: 0.8em;
        }

        #non-playing-opponents-list li::before {
            content: "\2022"; /* הצגת נקודה ממורכזת */
            margin-left: 2px; /* רווח בין הנקודה לשם */
            float: right;
            margin-top: 0; /* Add top margin */
            list-style-type: none; /* Remove bullet points */
            padding-right: 0; /* Remove default right padding */
            color: black; /* Set color for bullet point */
        }

        #titles-container {
            display: flex;
            align-items: right;
            justify-content: space-between;
            /* margin-bottom: 20px; Add margin between titles and lists */
        }

        #opponents-container {
            float: right;
            width: 40%; /* Adjust width as needed */
            padding-left: 0px; /* Add space between opponents list and games list */
            display: none; /* Hide opponents list by default */
        }

        #opponents-container.show {
            display: block; /* Show opponents list when needed*/
            font-size: 15px;
        }

        #titles-container h2 {
            font-size: 1.5em; /* גודל כותרת משחקים */
        }

        #opponents-container h3 {
            text-align: right;
            font-size: 1em;
        }

        /*.below-average {
            background-color: rgb(255, 0, 0);
        }*/

    </style>
</head>
<body>

        <h2>Select a Player / בחירת שחקן</h2>
    <select id="player-select">
        <option value="">Select a player</option>
    </select>

    <div id="titles-container">   
        <div>
            <h2>Select a Cycle / בחירת מחזור</h2>
            <select id="round-select">
                <option value="">Select a cycle</option>
            </select>
        </div>

    </div>

    <div id="titles-container">   
        <div>
            <h2>Played / שוחקו</h2>
            <div id="games-list"></div>      
        </div>
        <div id="opponents-container">  
            <h3> <input type="checkbox" id="show-opponents" name="show-opponents"> יריבים שנשארו<br>Left opponents </h3>
                <ul id="non-playing-opponents-list"></ul>
        </div>
    </div>

    <script>
        // Google Sheets API Key
        const apiKey = 'AIzaSyAtPWvLQawbcd4vDiMyJk0bQG6AoTzYQZU';

        // Google Sheets Spreadsheet ID
        const spreadsheetId = '1QJCNQVtXOf2NF6R0uzbhi8own5hf0_E0K8QoailgMk4';

        // Fetch data from Google Sheets API
        function fetchDataFromGoogleSheets() {
            fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/Sheet1?key=${apiKey}`)
                .then(response => response.json())
                .then(data => {
                    const entries = data.values;
                    const selectPlayerElement = document.getElementById('player-select');
                    const selectRoundElement = document.getElementById('round-select');
                    const gamesList = document.getElementById('games-list');
                    const nonPlayingOpponentsList = document.getElementById('non-playing-opponents-list');
                    const dataTable = document.getElementById('data-table');
                    const opponentsContainer = document.getElementById('opponents-container');
                    const showOpponentsCheckbox = document.getElementById('show-opponents');
                    
                    displayUpdateTime(entries);
                    // Display the last update time written in colum P (Index 15)
                    function displayUpdateTime(entries) {
                        const updateTime = entries[1][15]; // Assuming row 2 and column P (column index 15)
                        const container = document.createElement('div'); // Create a container for both elements
                        container.style.display = "inline"; // Set the container to display inline

                        const secondCellTitle = document.createElement('h3');
                        secondCellTitle.textContent = " :Updated / עודכן";
                        secondCellTitle.style.display = "inline"; // Set the title to display inline
                        secondCellTitle.style.color = "blue";

                        const secondCellContainer = document.createElement('div');
                        secondCellContainer.textContent = updateTime;
                        secondCellContainer.style.display = "inline"; // Set the value to display inline
                        secondCellContainer.style.color = "blue";
                        secondCellContainer.style.fontWeight = "bold";

                        container.appendChild(secondCellContainer); // Append the value to the container
                        container.appendChild(secondCellTitle); // Append the title to the container

                        document.body.insertBefore(container, document.body.firstChild); // Insert the container at the beginning of the body
                    }       

                    // Populate player selection dropdown
                    const playerNames = [];
                    for (let i = 3; i < entries.length; i++) {
                        const playerName = entries[i][1].trim(); // Assuming player names are in column B
                        if (playerName) {
                            playerNames.push(playerName);
                        }
                    }

                    // Sort player names alphabetically
                    playerNames.sort().forEach(playerName => {
                        const option = document.createElement('option');
                        option.textContent = playerName;
                        option.value = playerName;
                        selectPlayerElement.appendChild(option);
                    });

                    // Populate round selection dropdown
                    const roundOptions = new Set();
                    for (let i = 3; i < entries.length; i++) {
                        const roundNumber = entries[i][6].trim(); // Assuming round numbers are in column G (column index 6)
                        if (roundNumber) {
                            roundOptions.add(roundNumber);
                        }
                    }

                    roundOptions.forEach(roundNumber => {
                        const option = document.createElement('option');
                        option.textContent = `Cycle ${roundNumber}`;
                        option.value = roundNumber;
                        selectRoundElement.appendChild(option);
                    });

                    // Function to display games played by selected player and round
                    function displayGames() {
                        const selectedPlayer = selectPlayerElement.value;
                        const selectedRound = selectRoundElement.value;
                        gamesList.innerHTML = ''; // Clear previous games

                        let currentCycleTitle;

                        entries.forEach((entry, index) => {
                            if (index >= 3) {
                                const player = entry[9].trim(); // Assuming player names are in column J (column index 9)
                                const round = entry[6].trim(); // Assuming round numbers are in column G (column index 6)
                                if (player === selectedPlayer && (!selectedRound || round === selectedRound)) {
                                    const playerScore = parseFloat(entry[11].trim()); // Assuming player's score is in column L (column index 11)
                                    const opponentScore = parseFloat(entry[12].trim()); // Assuming opponent's score is in column M (column index 12)
                                    const isPlayerWinner = playerScore > opponentScore;
                                    const isOpponentWinner = playerScore < opponentScore;

                                    if (round !== currentCycleTitle) { // Check if a new cycle has started
                                        const cycleTitle = document.createElement('h3');
                                        cycleTitle.textContent = `Cycle ${round}`;
                                        gamesList.appendChild(cycleTitle);
                                        currentCycleTitle = round;
                                    }

                                    const gameItem = document.createElement('li');
                                    const gameSpan = document.createElement('span');
                                    const gameText = [player, entry[10].trim(), entry[11].trim(), entry[12].trim()].join(' - '); // Combine player, opponent, and scores
                                    gameSpan.textContent = gameText;
                                    // Apply color based on game result
                                    if (isPlayerWinner) {
                                        gameSpan.classList.add('winner');
                                    } else if (isOpponentWinner) {
                                        gameSpan.classList.add('loser');
                                    }
                                    gameItem.appendChild(gameSpan);
                                    gamesList.appendChild(gameItem);
                                }
                            }
                        });
                    }

                    // Function to display non-playing opponents for the selected player
                    function displayNonPlayingOpponents(selectedPlayer) {
                        nonPlayingOpponentsList.innerHTML = ''; // Clear previous list

                        const allPlayers = Array.from(playerNames); // Convert Array to Array (just to make a copy)

                        allPlayers.forEach(playerName => {
                            if (playerName !== selectedPlayer) {
                                let hasPlayedAgainst = false;
                                for (let i = 3; i < entries.length; i++) {
                                    const player = entries[i][9].trim(); // Assuming player names are in column J (column index 9)
                                    const opponent = entries[i][10].trim(); // Assuming opponent names are in column K (column index 10)
                                    if (player === selectedPlayer && opponent === playerName) {
                                        hasPlayedAgainst = true;
                                        break;
                                    }
                                }
                                if (!hasPlayedAgainst) {
                                    const listItem = document.createElement('li');
                                    listItem.textContent = playerName;
                                    nonPlayingOpponentsList.appendChild(listItem);
                                }
                            }
                        });
                    }

                    // Function to calculate and display percentage of games played next to player name
                    function displayGamesPercentage() {
                        const selectedPlayer = selectPlayerElement.value;
                        const totalGames = 100; // Assuming total games
                        let playerGames = 0;
                        entries.forEach((entry, index) => {
                            if (index >= 3) {
                                const player = entry[9].trim(); // Assuming player names are in column J (column index 9)
                                if (player === selectedPlayer) {
                                    playerGames++;
                                }
                            }
                        });
                        const percentage = ((playerGames / (playerNames.length - 1)) * 100).toFixed(1);


                        const playerOption = document.querySelector(`#player-select option[value="${selectedPlayer}"]`);
                        playerOption.textContent = `${selectedPlayer} (${percentage}%)`;
                    }

                    // Event listener for player selection
                    selectPlayerElement.addEventListener('change', () => {
                        const selectedPlayer = selectPlayerElement.value;
                        displayGames(); // Update games list
                        if (showOpponentsCheckbox.checked) {
                            displayNonPlayingOpponents(selectedPlayer); // Update non-playing opponents list
                        }
                        // Hide opponents list when no player is selected
                        if (!selectedPlayer) {
                            opponentsContainer.classList.remove('show');
                        }
                    });

                    // Event listeners for player and round selection
                    selectPlayerElement.addEventListener('change', displayGames);
                    selectRoundElement.addEventListener('change', () => {
                        displayGames();
                        if (showOpponentsCheckbox.checked) {
                            displayNonPlayingOpponents(selectPlayerElement.value);
                        }
                    });

                    // Show opponents list when player is selected
                    selectPlayerElement.addEventListener('change', () => {
                        if (selectPlayerElement.value) {
                            opponentsContainer.classList.add('show');
                        } else {
                            opponentsContainer.classList.remove('show');
                        }
                    });

                    // Event listener for showing/hiding non-playing opponents
                    showOpponentsCheckbox.addEventListener('change', () => {
                        const selectedPlayer = selectPlayerElement.value;
                        if (showOpponentsCheckbox.checked && selectedPlayer) {
                            displayNonPlayingOpponents(selectedPlayer);
                        } else {
                            nonPlayingOpponentsList.innerHTML = ''; // Clear opponents list
                        }
                    });
                    // Calculate the average number of games played by all players
                    function calculateAverageGames() {
                        const playerRows = document.querySelectorAll('#data-table tr');
                        let totalGames = 0;
                        let playerCount = 0;

                        playerRows.forEach(row => {
                            const gamesPlayedCell = row.children[3]; // Assuming games played are in the 4th column (index 3)
                            const gamesPlayed = parseInt(gamesPlayedCell.textContent.trim());
                            if (!isNaN(gamesPlayed)) {
                                totalGames += gamesPlayed;
                                playerCount++;
                            }
                        });

                        return playerCount > 0 ? totalGames / playerCount : 0;
                    }

                    // Color cells based on the number of games played compared to the average
                    function colorCells() {
                        const playerRows = document.querySelectorAll('#data-table tr');
                        const averageGames = calculateAverageGames();

                        playerRows.forEach(row => {
                            const gamesPlayedCell = row.children[3]; // Assuming games played are in the 4th column (index 3)
                            const gamesPlayed = parseInt(gamesPlayedCell.textContent.trim());
                            if (!isNaN(gamesPlayed) && gamesPlayed < averageGames) {
                                gamesPlayedCell.style.backgroundColor = 'rgb(255, 183, 183)';
                            }
                        });
                    }

                    // Display data table from row 4
                    for (let i = 3; i < 36; i++) {
                        const cells = entries[i];
                        if (cells.length >= 6) { // Ensure at least 6 columns are available
                            const row = document.createElement('tr');
                            for (let j = 5; j >= 0; j--) { // Displaying only columns 1 to 6
                                const cellElement = document.createElement('td');
                                const cellContent = cells[j].trim();
                                cellElement.textContent = cellContent;
                                row.appendChild(cellElement);
                                // Apply style for cells with numbers less than -100
                                if (j === 5 && !isNaN(cellContent) && parseInt(cellContent) === -100) {
                                    cellElement.style.backgroundColor = 'white'; // Change background color to white
                                    cellElement.style.color = 'white'; // Change text color to white
                                }
                            }
                            dataTable.appendChild(row);
                        }
                    }
                    // Set table headers
                    const tableHeaders = ['יחס', 'הפסדים', 'נצחונות', 'משחקים', 'שחקן', 'מיקום'];
                    const headerRow = document.createElement('tr');
                    tableHeaders.forEach(headerText => {
                        const headerCell = document.createElement('th');
                        headerCell.textContent = headerText;
                        headerRow.appendChild(headerCell);
                    });
                    dataTable.insertBefore(headerRow, dataTable.firstChild);
                    // Call function to display games percentage when player selection changes
                    selectPlayerElement.addEventListener('change', displayGamesPercentage);

                    // Call function to color cells based on games played compared to average
                    colorCells();

                })
                .catch(error => console.error('Error fetching data:', error));
        }

        // Call function to fetch data from Google Sheets API
        fetchDataFromGoogleSheets(); 
    </script>

    <h2>טבלה מסכמת<br>Summarizing table</h2>
    <table id="data-table">
        <tbody id="data-body"></tbody>
    </table>
</body>
</html>
